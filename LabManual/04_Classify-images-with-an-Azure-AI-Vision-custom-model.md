---
lab:
    title: 'Azure AI Custom Vision を使用して画像を分類する'
---

# Azure AI Custom Vision を使用して画像を分類する

**Azure AI Custom Vision** サービスを使用すると、自分の画像でトレーニングされたコンピュータービジョンモデルを作成できます。これを使用して、*画像分類* および *物体検出* モデルをトレーニングし、それをアプリケーションから公開および利用できます。

この演習では、Custom Vision サービスを使用して、3 種類の果物 (りんご、バナナ、オレンジ) を識別できる画像分類モデルをトレーニングします。

## このコースのリポジトリをクローンする

まだ **mslearn-ai-vision** コードリポジトリをこのラボで作業している環境にクローンしていない場合は、次の手順に従ってクローンします。すでにクローンしている場合は、Visual Studio Code でクローンしたフォルダーを開きます。

1. Visual Studio Code を起動します。
2. パレット (SHIFT+CTRL+P) を開き、**Git: Clone** コマンドを実行して `https://github.com/MicrosoftLearning/mslearn-ai-vision` リポジトリをローカルフォルダーにクローンします (フォルダーはどこでも構いません)。
3. リポジトリがクローンされたら、Visual Studio Code でフォルダーを開きます。
4. リポジトリ内の C# コードプロジェクトをサポートするために追加のファイルがインストールされるのを待ちます。

    > **注**: ビルドおよびデバッグに必要なアセットを追加するように求められた場合は、**Not Now** を選択します。*Detected an Azure Function Project in folder* メッセージが表示された場合は、そのメッセージを安全に閉じることができます。

## Custom Vision リソースを作成する

モデルをトレーニングする前に、*トレーニング* および *予測* 用の Azure リソースが必要です。これらのタスクごとに **Custom Vision** リソースを作成するか、単一の **Azure AI Services** リソースを作成して、いずれか (または両方) に使用できます。

この演習では、トレーニングと予測のために **Custom Vision** リソースを作成し、これらのワークロードのアクセスとコストを個別に管理できるようにします。

1. 新しいブラウザタブで Azure ポータル `https://portal.azure.com` を開き、Azure サブスクリプションに関連付けられた Microsoft アカウントを使用してサインインします。
2. **&#65291;リソースの作成** ボタンを選択し、*custom vision* を検索して、次の設定で **Custom Vision** リソースを作成します：
    - **作成オプション**: 両方
    - **サブスクリプション**: あなたの Azure サブスクリプション
    - **リソースグループ**: *リソースグループを選択または作成 (制限付きサブスクリプションを使用している場合は、新しいリソースグループを作成する権限がない場合があります - 提供されたものを使用してください)*
    - **リージョン**: *利用可能なリージョンを選択*
    - **名前**: *一意の名前を入力*
    - **トレーニング価格レベル**: F0
    - **予測価格レベル**: F0

    > **注**: サブスクリプションにすでに F0 カスタムビジョンサービスがある場合は、**S0** を選択します。

3. リソースが作成されるのを待ち、デプロイメントの詳細を表示して、トレーニング用と予測用の 2 つの Custom Vision リソースがプロビジョニングされていることを確認します (**-Prediction** サフィックスで明らかです)。これらは、作成したリソースグループに移動して表示できます。

> **重要**: 各リソースには独自の *エンドポイント* と *キー* があり、コードからのアクセスを管理するために使用されます。画像分類モデルをトレーニングするには、コードで *トレーニング* リソース (そのエンドポイントとキー) を使用する必要があります。トレーニングされたモデルを使用して画像クラスを予測するには、コードで *予測* リソース (そのエンドポイントとキー) を使用する必要があります。

## Custom Vision プロジェクトを作成する

画像分類モデルをトレーニングするには、トレーニングリソースに基づいて Custom Vision プロジェクトを作成する必要があります。これを行うには、Custom Vision ポータルを使用します。

1. Visual Studio Code で、リポジトリをクローンした **07-custom-vision-image-classification/training-images** フォルダー内のトレーニング画像を表示します。このフォルダーには、りんご、バナナ、オレンジの画像のサブフォルダーが含まれています。
2. 新しいブラウザタブで Custom Vision ポータル `https://customvision.ai` を開きます。サインインを求められた場合は、Azure サブスクリプションに関連付けられた Microsoft アカウントを使用してサインインし、利用規約に同意します。
3. Custom Vision ポータルで、次の設定で新しいプロジェクトを作成します：
    - **名前**: Classify Fruit
    - **説明**: 果物の画像分類
    - **リソース**: *以前に作成した Custom Vision リソース*
    - **プロジェクトタイプ**: 分類
    - **分類タイプ**: マルチクラス (画像ごとに 1 つのタグ)
    - **ドメイン**: 食品
4. 新しいプロジェクトで、**\[+\] 画像を追加** をクリックし、以前に表示した **training-images/apple** フォルダー内のすべてのファイルを選択します。次に、画像ファイルをアップロードし、タグ *apple* を指定します。このように：

![アップルのタグ付きアップルのアップロード](../media/upload_apples.jpg)
   
5. 前の手順を繰り返して、**banana** フォルダー内の画像をタグ *banana* で、**orange** フォルダー内の画像をタグ *orange* でアップロードします。
6. Custom Vision プロジェクトにアップロードした画像を確認します。各クラスの画像が 15 枚あるはずです。このように：

![タグ付き果物の画像 - 15 個のりんご、15 個のバナナ、15 個のオレンジ](../media/fruit.jpg)
    
7. Custom Vision プロジェクトで、画像の上にある **トレーニング** をクリックして、タグ付き画像を使用して分類モデルをトレーニングします。**クイックトレーニング** オプションを選択し、トレーニングの反復が完了するのを待ちます (これには 1 分ほどかかる場合があります)。
8. モデルの反復がトレーニングされたら、*Precision*、*Recall*、および *AP* のパフォーマンス指標を確認します。これらは分類モデルの予測精度を測定し、すべて高いはずです。

> **注**: パフォーマンス指標は、各予測の確率しきい値 50% に基づいています (つまり、モデルが特定のクラスの画像である確率が 50% 以上と計算した場合、そのクラスが予測されます)。ページの左上でこれを調整できます。

## モデルをテストする

モデルをトレーニングしたので、テストできます。

1. パフォーマンス指標の上にある **クイックテスト** をクリックします。
2. **画像 URL** ボックスに `https://aka.ms/apple-image` と入力し、&#10132; をクリックします。
3. モデルによって返された予測を表示します。*apple* の確率スコアが最も高いはずです。このように：

![クラス予測がアップルの画像](../media/test-apple.jpg)

4. **クイックテスト** ウィンドウを閉じます。

## プロジェクト設定を表示する

作成したプロジェクトには一意の識別子が割り当てられており、これをコードで指定する必要があります。

1. **パフォーマンス** ページの右上にある *設定* (&#9881;) アイコンをクリックして、プロジェクト設定を表示します。
2. 左側の **一般** の下で、このプロジェクトを一意に識別する **プロジェクト ID** を確認します。
3. 右側の **リソース** の下で、キーとエンドポイントが表示されていることを確認します。これらは *トレーニング* リソースの詳細です (この情報は Azure ポータルでリソースを表示することでも取得できます)。

## *トレーニング* API を使用する

Custom Vision ポータルは、画像のアップロードとタグ付け、およびモデルのトレーニングに便利なユーザーインターフェイスを提供します。ただし、いくつかのシナリオでは、Custom Vision トレーニング API を使用してモデルのトレーニングを自動化したい場合があります。

> **注**: この演習では、**C#** または **Python** SDK のいずれかを使用して API を使用できます。以下の手順では、好みの言語に応じて適切な操作を行います。

1. Visual Studio Code で、**Explorer** ペインで **07-custom-vision-image-classification** フォルダーに移動し、言語の好みに応じて **C-Sharp** または **Python** フォルダーを展開します。
2. **train-classifier** フォルダーを右クリックして統合ターミナルを開きます。次に、言語の好みに応じて適切なコマンドを実行して Custom Vision トレーニングパッケージをインストールします：

**C#**

```
dotnet add package Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training --version 2.0.0
```

**Python**

```
pip install azure-cognitiveservices-vision-customvision==3.1.0
```

3. **train-classifier** フォルダーの内容を表示し、設定ファイルが含まれていることを確認します：
    - **C#**: appsettings.json
    - **Python**: .env

    設定ファイルを開き、Custom Vision *トレーニング* リソースのエンドポイントとキー、および以前に作成した分類プロジェクトのプロジェクト ID を反映するように設定値を更新します。変更を保存します。
4. **train-classifier** フォルダーにはクライアントアプリケーションのコードファイルが含まれていることを確認します：

    - **C#**: Program.cs
    - **Python**: train-classifier.py

    コードファイルを開き、含まれているコードを確認します。次の詳細に注意してください：
    - インストールしたパッケージの名前空間がインポートされています。
    - **Main** 関数は設定を取得し、キーとエンドポイントを使用して認証された **CustomVisionTrainingClient** を作成し、プロジェクト ID を使用してプロジェクトへの **Project** 参照を作成します。
    - **Upload_Images** 関数は Custom Vision プロジェクトで定義されたタグを取得し、対応する名前のフォルダーから画像ファイルをプロジェクトにアップロードし、適切なタグ ID を割り当てます。
    - **Train_Model** 関数はプロジェクトの新しいトレーニング反復を作成し、トレーニングが完了するのを待ちます。
5. **train-classifier** フォルダーの統合ターミナルに戻り、次のコマンドを入力してプログラムを実行します：

**C#**

```
dotnet run
```

**Python**

```
python train-classifier.py
```
    
6. プログラムが終了するのを待ちます。次に、ブラウザに戻り、必要に応じてブラウザを更新して Custom Vision ポータルのプロジェクトの **トレーニング画像** ページを表示します。
7. プロジェクトに新しいタグ付き画像が追加されていることを確認します。次に、**パフォーマンス** ページを表示し、新しい反復が作成されていることを確認します。

## 画像分類モデルを公開する

トレーニングされたモデルをクライアントアプリケーションから使用できるように公開する準備が整いました。

1. Custom Vision ポータルの **パフォーマンス** ページで、画面上部の**&#128504; 公開** をクリックして、次の設定でトレーニングされたモデルを公開します：
    - **モデル名**: fruit-classifier
    - **予測リソース**: *以前に作成した **-Prediction** で終わる **予測** リソース (<u>トレーニングリソースではありません</u>)*。
2. **プロジェクト設定** ページの左上で、*プロジェクトギャラリー* (&#128065;) アイコンをクリックして Custom Vision ポータルのホームページに戻ります。ここにプロジェクトがリストされています。
3. Custom Vision ポータルのホームページで、右上の *設定* (&#9881;) アイコンをクリックして Custom Vision サービスの設定を表示します。次に、**リソース** の下で、**-Prediction** で終わる *予測* リソース (<u>トレーニングリソースではありません</u>) を見つけ、その **キー** と **エンドポイント** の値を確認します (この情報は Azure ポータルでリソースを表示することでも取得できます)。

## クライアントアプリケーションから画像分類器を使用する

画像分類モデルを公開したので、クライアントアプリケーションから使用できます。再び、**C#** または **Python** を使用できます。

1. Visual Studio Code で、**07-custom-vision-image-classification** フォルダー内のサブフォルダー (**C-Sharp** または **Python**) で **test-classifier** フォルダーを右クリックして統合ターミナルを開きます。次に、Custom Vision 予測パッケージをインストールするために適切な SDK 固有のコマンドを入力します：

**C#**

```
dotnet add package Microsoft.Azure.CognitiveServices.Vision.CustomVision.Prediction --version 2.0.0
```

**Python**

```
pip install azure-cognitiveservices-vision-customvision==3.1.0
```

> **注**: Python SDK パッケージにはトレーニングおよび予測パッケージの両方が含まれており、すでにインストールされている場合があります。

2. **test-classifier** フォルダーを展開して、画像分類モデルのテストクライアントアプリケーションを実装するために使用されるファイルを表示します。
3. クライアントアプリケーションの設定ファイル (*appsettings.json* for C# または *.env* for Python) を開き、Custom Vision *予測* リソースのエンドポイントとキー、分類プロジェクトのプロジェクト ID、および公開されたモデルの名前 (*fruit-classifier* であるはずです) を反映するように設定値を更新します。変更を保存します。
4. クライアントアプリケーションのコードファイル (*Program.cs* for C#、*test-classification.py* for Python) を開き、含まれているコードを確認します。次の詳細に注意してください：
    - インストールしたパッケージの名前空間がインポートされています。
    - **Main** 関数は設定を取得し、キーとエンドポイントを使用して認証された **CustomVisionPredictionClient** を作成します。
    - 予測クライアントオブジェクトは、各リクエストに対してプロジェクト ID とモデル名を指定して **test-images** フォルダー内の各画像のクラスを予測するために使用されます。各予測には各クラスの確率が含まれており、50% を超える確率を持つ予測タグのみが表示されます。
5. **test-classifier** フォルダーの統合ターミナルに戻り、次の SDK 固有のコマンドを入力してプログラムを実行します：

**C#**

```
dotnet run
```

**Python**

```
python test-classifier.py
```

6. 各予測のラベル (タグ) と確率スコアを確認します。**test-images** フォルダー内の画像を表示して、モデルが正しく分類されていることを確認できます。

## 詳細情報

Custom Vision サービスを使用した画像分類の詳細については、[Custom Vision ドキュメント](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/) を参照してください。
